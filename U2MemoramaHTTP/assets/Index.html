
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Memorama Supernatural</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: #000 url('/memorama/assets/fondo.png') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        h1 {
            font-family: 'Cinzel Decorative', serif;
            font-size: 4rem;
            letter-spacing: 5px;
            color: #fff;
            text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 40px #ff0000, 0 0 60px #000, 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        #formulario {
            margin-top: 2rem;
            text-align: center;
        }

        input[type="text"] {
            padding: 10px;
            font-size: 1rem;
            border-radius: 10px;
            border: none;
            margin-right: 10px;
        }

        .paresDiv {
            display: flex;
            align-items: center;
            align-content:center;
            justify-content: center;
            gap: 10px;
        }

        label {
            margin-right: 10px;
            text-align: center;
        }

        #lbl-nivel {
            margin-top: 20px;
            font-size:20px;
            font-weight:bold;
        }

        #cantidad-pares {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            padding: 10px;
            font-size: 1rem;
            border-radius: 10px;
            border: none;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        button {
            background: #444;
            color: #fff;
            padding: 10px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

            button:hover {
                background: #666;
            }

        #juego {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        #infoJuego {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.2rem;
            background-color: rgba(0, 0, 0, 0.6);
            flex-wrap: wrap;
            box-shadow: 0 0 10px #ff0000;
        }

        .jugador-info {
            text-align: center;
            margin: 10px;
        }

        .turno-info {
            width: 100%;
            text-align: center;
            margin-top: 10px;
        }



        #tablero {
            display: grid;
            grid-template-columns: repeat(4, 100px);
            gap: 15px;
            margin-bottom: 2rem;
        }


        #tablero {
            display: grid;
            grid-template-columns: repeat(4, 100px);
            gap: 15px;
            margin-bottom: 2rem;
        }

        .carta {
            width: 100px;
            height: 140px;
            perspective: 1000px;
            cursor: pointer;
        }

        .carta-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .carta.volteada .carta-inner {
            transform: rotateY(180deg);
        }

        .carta-front, .carta-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
        }

        .carta-back {
            background-image: url('/memorama/assets/traserocarta.png');
            background-color: #111;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
        }

        .carta-front {
            transform: rotateY(180deg);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #000;
        }


        button {
            background: #444;
            color: #fff;
            padding: 10px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

            button:hover {
                background: #666;
            }
        .pantalla-oculta {
            display: none !important;
            /*Asegura que no se muestre al cargar la página*/
        }

        #pantalla-final {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 30, 30, 0.95);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: aparecer 1s ease-in-out;
        }
        .contenedor-final {
            text-align: center;
            background: #2a2a2a; 
            padding: 2em;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.9);
            animation: subir 0.6s ease;
        }

        @keyframes aparecer {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes subir {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .contenedor-final button {
            margin-top: 1em;
            padding: 0.5em 1.2em;
            border: none;
            background-color: #28a745;
            color: white;
            font-size: 1em;
            border-radius: 10px;
            cursor: pointer;
        }
        /* Contenedor de los botones de cantidad de pares */
        .cantidad-pares-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }

        .pares-button {
            background-color: #ff0000;
            color: #fff; 
            padding: 10px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .pares-button:hover {
                background-color: #fff;
                color: red;
                box-shadow: 0 0 20px #ff0000, 0 0 20px #ff0000, 0 0 20px #ff0000, 0 0 30px #000, 2px 2px 4px rgba(0, 0, 0, 0.8);
            }

            .pares-button.selected {
                background-color: #fff;
                color:red;
            }

            .pares-button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }

    </style>
</head>
<body>

    <h1>SUPERNATURAL</h1>

    <div id="formulario">
        <div class="paresDiv">
            <label for="pares" id="lbl-nivel">Nivel:</label>

            <div id="cantidad-pares" class="cantidad-pares-buttons">
                <button class="pares-button" data-pares="4">4x4</button>
                <button class="pares-button" data-pares="5">5x5</button>
                <button class="pares-button" data-pares="6">6x6</button>
            </div>
        </div>
        
        <input type="text" id="inputNombre" placeholder="Escribe tu nombre">

        <button id="start-button" class="start">Iniciar</button>
        <h2 id="game-status" class="status" hidden>Esperando a otro jugador...</h2>
    </div>

    <div id="juego" hidden>
        <div>Tiempo: <span id="tiempo">00:00</span></div>
        <div id="infoJuego">
            <div class="jugador-info">
                <div id="nombreJugador"></div>
                <div>Pares: <span id="movimientos">0</span></div>
            </div>
            <div class="jugador-info">
                <div id="nombreJugador2"></div>
                <div>Pares: <span id="movimientos2">0</span></div>
            </div>
            <div class="turno-info">
                <p><strong>Turno de:</strong> <span id="currentPlayer"></span></p>
            </div>
        </div>
        <div id="tablero"></div>
        <button onclick="reiniciarJuego()">Reiniciar</button>
        <section class="status">
            <span id="turn-message"></span>
        </section>
    </div>
    <div id="pantalla-final" class="pantalla-oculta">
        <div class="contenedor-final">
            <h2>¡Juego Finalizado!</h2>
            <p id="tiempo-final" style="margin-top: 1em; font-size: 1.1em;"></p>
            <p id="mensaje-final"></p>
            <div class="puntajes">
                <p id="puntaje-jugador1"></p>
                <p id="puntaje-jugador2"></p>
            </div>


            <button onclick="reiniciarJuego()">Jugar de nuevo</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10000;"></canvas>


    <script>
        const personajes = [
            { nombre: "Dean", img: "/memorama/assets/dean.png" },
            { nombre: "Sam", img: "/memorama/assets/sam.png" },
            { nombre: "Castiel", img: "/memorama/assets/castiel.png" },
            { nombre: "Crowley", img: "/memorama/assets/jhon.png" },
            { nombre: "Bobby", img: "/memorama/assets/jack.png" },
            { nombre: "Lucifer", img: "/memorama/assets/charlie.png" },
            { nombre: "Amara", img: "/memorama/assets/amara.png" },
            { nombre: "Crowley", img: "/memorama/assets/crowley.jpeg" },
        ];

        let cartas = [];
        let primera = null;
        let segunda = null;
        let bloqueo = false;
        let movimientos = 0;
        let movimientos2 = 0;
        let tiempo = 0;
        let intervaloTiempo = null;

        const startButton = document.getElementById("start-button");
        const playerNameSection = document.getElementById("formulario");
        const playerNameInput = document.getElementById("inputNombre");
        const tablero = document.getElementById('tablero');
        const spanMovimientos = document.getElementById('movimientos');
        const spanMovimientos2 = document.getElementById('movimientos2');
        const spanTiempo = document.getElementById('tiempo');
        const juegoSection = document.getElementById('juego');
        const gameStatus = document.getElementById("game-status");
        const turnMessage = document.getElementById("turn-message");
        const player1 = document.getElementById("nombreJugador");
        const player2 = document.getElementById("nombreJugador2");
        const turno = document.getElementById("currentPlayer");

        let nombre, idSesion, soyJugador1 = false;

        let estado = {
            Jugador1: player1,
            Jugador2: player2,
            Turno: turno,
        }

        const jugadorConTurno = estado.Turno.textContent || estado.Turno.innerText;
        console.log("Jugador con turno:", jugadorConTurno);

        let selectedParesButton = null;
        let cantidadPares = null;

      
        document.querySelectorAll('.pares-button').forEach(button => {
            button.addEventListener('click', function () {

                if (!button.disabled) {

                    if (selectedParesButton) {
                        selectedParesButton.classList.remove('selected');
                    }

                    button.classList.add('selected');
                    cantidadPares = parseInt(button.getAttribute('data-pares'), 10);
                    selectedParesButton = button; 
                }
            });
        });


        startButton.addEventListener("click", async () => {
            if (playerNameInput.value.trim()) {
                nombre = playerNameInput.value.trim();

                if (!cantidadPares) {
                    alert("Por favor, selecciona un nivel para jugar.");
                    return;
                }
              
                if (cantidadPares < 4 || cantidadPares > 6) {
                    alert("Por favor, selecciona un nivel para jugar.");
                    return;
                }

                let json = { Nombre: nombre, CantidadPares: cantidadPares };

                gameStatus.hidden = false;
                playerNameInput.disabled = true;

                try {

                    let response = await fetch("/memorama/quierojugar", {
                        method: "POST",
                        body: JSON.stringify(json),
                        headers: { "Content-Type": "application/json" }
                    });

                    // Si la respuesta no es exitosa, manejar el error
                    if (!response.ok) {
                        let errorx = await response.json();
                        alert(errorx.error);
                        playerNameInput.disabled = false;
                        return;
                    }
                    if (response.ok) {
                        let juego = await response.json();

                        playerNameSection.hidden = true;
                        juegoSection.style.display = 'flex';


                        idSesion = juego.IdSesion;
                        player1.innerText = juego.Jugador1;
                        player2.innerText = juego.Jugador2;
                        turno.innerText = juego.Turno;

                        if (juego.Jugador1 == nombre) {
                            player1.style.color = "red";
                        }
                        else {
                            player2.style.color = "red";
                        }

                        const cartasBarajadas = juego.Cartas;
                        iniciarTemporizador();

                        // Crear cartas destapadas inicialmente
                        crearCartas(cartasBarajadas);
                        destaparTodasLasCartas();

                        // Esper 2 segundos, luego las tapamos
                        setTimeout(() => {
                            taparTodasLasCartas();

                            if (juego.Turno == nombre) {
                                habilitarTablero();
                            } else {
                                esperar();
                            }
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error de conexión:', error);
                    alert("Hubo un problema con la conexión al servidor.");
                }

               
            } else {
                alert("Escribe el nombre del usuario para comenzar.");
            }
        });

        function crearCartas(cartasBarajadas) {
            cartas = cartasBarajadas;
            tablero.innerHTML = '';

            cartas.forEach((indice, i) => {
                console.log(`Buscando personaje con índice: ${indice}`);

                // El índice para acceder al personaje en el arreglo de personajes
                const personaje = personajes[indice];

                console.log('Cartas:', cartas);
                console.log('Personajes:', personajes);

                if (personaje) {
                    const carta = document.createElement('div');
                    carta.classList.add('carta');
                    carta.dataset.nombre = personaje.nombre;
                    carta.dataset.index = i;

                    carta.innerHTML = `
                                    <div class="carta-inner">
                                        <div class="carta-front" style="background-image: url('${personaje.img}')"></div>
                                        <div class="carta-back"></div>
                                    </div>
                                `;

                    carta.addEventListener('click', () => jugar(i));
                    tablero.appendChild(carta);

                }
                else {
                    console.error(`No se encontró el personaje para: ${nombreCarta}`);
                }
            });
        }

        async function jugar(indice) {
            if (bloqueo || cartas[indice].volteada) return;

            // Verificar si es el turno del jugador
            const jugadorConTurno = estado.Turno.textContent || estado.Turno.innerText;

            if (jugadorConTurno !== nombre) {
                alert("No es tu turno.");
                return;
            }

            const audioVoltear = new Audio('/memorama/assets/pop.mp3');
            audioVoltear.play();

            // Voltear carta localmente
            cartas[indice].volteada = true;
            const carta = tablero.children[indice];
            carta.classList.add('volteada');
            

            if (primera === null) {
                primera = indice;
                return;
            }

            segunda = indice;
            bloqueo = true;


            //Un segundo al usuario para ver la segunda carta antes de enviar
            setTimeout(async () => {
                const payload = {
                    Indice1: primera, Indice2: segunda, IdSesion: idSesion,
                    Nombre: jugadorConTurno
                };

                try {
                    const res = await fetch("/memorama/jugada", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                
                    const estado = await res.json();

             
                    if (estado.error) {
                        alert(estado.error);

                        // Volver a cubrir las dos cartas que volteaste localmente
                        tablero.children[primera].classList.remove('volteada');
                        tablero.children[segunda].classList.remove('volteada');
                        cartas[primera].volteada = false;
                        cartas[segunda].volteada = false;
                    }
                    else {
                        if (estado.Cartas[primera] === -1 && estado.Cartas[segunda] === -1) {
                            console.log("¡Pareja encontrada!");

                            actualizarVista(estado);
                        }
                        else {
                            // No eran pareja, volver a tapar
                            tablero.children[primera].classList.remove('volteada');
                            tablero.children[segunda].classList.remove('volteada');
                            cartas[primera].volteada = false;
                            cartas[segunda].volteada = false;
                        }

                        actualizarVista(estado);

                        if (!estado.EsMiTurno) esperar();
                    }
                }
                catch (e) {
                    console.error("Error de red o al comprobar el JSON:", e);
                } finally {
                    // limpia el estado local de la jugada
                    primera = null;
                    segunda = null;
                    bloqueo = false;
                }
            }, 1000);
        }

        async function esperar() {

            let json = { IdSesion: idSesion, Nombre: nombre };
            try {
                let res = await fetch("/memorama/esperando", {
                    method: "POST",
                    body: JSON.stringify(json),
                    headers: { "Content-Type": "application/json" }
                });

                if (res.ok) {
                    try {
                        let estado = await res.json();
                     
                        actualizarVista(estado);
                        
                        if (!estado.finalizado) {
                            // Si el juego no ha terminado, seguimos esperando
                            actualizarVista(estado);

                        } else if (estado.finalizado) {
                            clearInterval(intervaloTiempo);

                            const pantallaJuego = document.getElementById("juego");
                            if (pantallaJuego) pantallaJuego.hidden = true;

                            actualizarVista({
                                Cartas: estado.cartas,
                                Turno: "",
                                Jugador1: estado.jugador1,
                                Jugador2: estado.jugador2,
                                spanMovimientos: estado.paresJugador1,
                                spanMovimientos2: estado.paresJugador2,
                                tiempo: formatearTiempo(estado.tiempo)
                            });

                            return;
                        }

                    } catch (e) {
                        console.error("Error al parsear JSON:", e);
                        setTimeout(esperar, 1000);
                    }
                } else {
                    console.error("Error en esperar:", res.statusText);
                    setTimeout(esperar, 1000);
                }
            } catch (error) {
                console.error("Error al realizar la solicitud:", error);
                setTimeout(esperar, 1000);
            }
        }

        function actualizarVista(estado) {
            // Actualizar el turno actual
            turno.innerText = estado.Turno;

            spanMovimientos.innerText = estado.ParesJugador1;
            spanMovimientos2.innerText = estado.ParesJugador2;

            // Actualizar el tablero de cartas
            estado.Cartas.forEach((valor, i) => {
                const carta = tablero.children[i];
                if (valor === -1) {
                    carta.classList.add('volteada');
                    carta.style.pointerEvents = "none";
                }
            });

            
            if (estado.Turno === player1.textContent) {
                player1.style.color = "red";
                player2.style.color = "white";
            } else {
                player2.style.color = "red";
                player1.style.color = "white";
            }

            // Verificar si el juego ha terminado (todas las cartas están volteadas)
            const juegoFinalizado = estado.Cartas.every(valor => valor === -1);
            if (juegoFinalizado) {
                clearInterval(intervaloTiempo);

                let ganador;
                if (estado.ParesJugador1 > estado.ParesJugador2) {
                    ganador = player1.textContent;
                } else if (estado.ParesJugador2 > estado.ParesJugador1) {
                    ganador = player2.textContent;
                } else {
                    ganador = "Empate";
                }


                const pantallaFinal = document.getElementById("pantalla-final");
                pantallaFinal.hidden = false;
                pantallaFinal.classList.remove("pantalla-oculta");
                pantallaFinal.style.display = "flex";

                const mensaje = (ganador === 'Empate')
                    ? '¡Hubo un empate!'
                    : `🏆 ¡Felicidades, Ganó ${ganador}!`;
                //sonido de ganador:


                document.getElementById("mensaje-final").textContent = mensaje;
                document.getElementById("puntaje-jugador1").textContent = `${estado.Jugador1}: ${estado.ParesJugador1} parejas`;
                document.getElementById("puntaje-jugador2").textContent = `${estado.Jugador2}: ${estado.ParesJugador2} parejas`;
                document.getElementById('tiempo-final').textContent = `⏱️ Tiempo total: ${tiempo} segundos`;
                const audioVoltear = new Audio('/memorama/assets/victory.mp3');
                audioVoltear.play();

                lanzarConfeti();
            }
        }

        function actualizarCartas(cartas) {
            cartas.forEach((valor, i) => {
                const carta = document.querySelector(`[data-index='${i}']`);
                if (carta) {
                    if (valor === -1) {
                        carta.style.visibility = "hidden";
                    } else {
                        const personaje = personajes[valor];
                        carta.querySelector('.carta-front').style.backgroundImage = `url('${personaje.img}')`;
                    }
                }
            });
        }

       
        function destaparTodasLasCartas() {
            const cartas = document.querySelectorAll('.carta');
            cartas.forEach(carta => {
                carta.classList.add('volteada');
                carta.style.pointerEvents = "none"; 
            });
        }

        function taparTodasLasCartas() {
            const cartas = document.querySelectorAll('.carta');
            cartas.forEach(carta => {
                carta.classList.remove('volteada');
                carta.style.pointerEvents = "";
            });
        }

        function lanzarConfeti() {
            const canvas = document.getElementById('confetti-canvas');
            const myConfetti = confetti.create(canvas, { resize: true, useWorker: true });

            const duration = 3 * 1000;
            const end = Date.now() + duration;

            (function frame() {
                // Lado izquierdo
                myConfetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#800080', '#40E0D0', '#ffffff']
                });

                // Lado derecho
                myConfetti({
                    particleCount: 4,
                    angle: 120,
                    spread: 55,
                    origin: { x:1},
                    colors: ['#800080', '#40E0D0', '#ffffff']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            })();
        }

        function deshabilitarTablero() {
            for (let carta of tablero.children) {
                carta.style.pointerEvents = "none";
            }
        }

        function habilitarTablero() {
            for (let carta of tablero.children) {
                carta.style.pointerEvents = "auto";
            }
        }


        async function reiniciarJuego() {
            idSesion = null;
            nombre = null;
            cantidadPares = null;
            estado.jugador2 = null;
            estado.jugador1 = null;

            gameStatus.hidden = true;
            playerNameInput.disabled = false;
            playerNameInput.value = "";
            playerNameSection.hidden = false;
            juegoSection.style.display = 'none';

            location.reload();
        }


        function iniciarTemporizador() {
            intervaloTiempo = setInterval(() => {
                tiempo++;
                spanTiempo.textContent = formatearTiempo(tiempo);
            }, 1000);
        }

        function formatearTiempo(segundos) {
            const mins = Math.floor(segundos / 60).toString().padStart(2, '0');
            const secs = (segundos % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }


    </script>
</body>
</html>

