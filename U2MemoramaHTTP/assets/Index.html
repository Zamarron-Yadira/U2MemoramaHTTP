
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Memorama Supernatural</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: #000 url('/memorama/assets/fondo.png') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        h1 {
            font-family: 'Cinzel Decorative', serif;
            font-size: 4rem;
            letter-spacing: 5px;
            color: #fff;
            text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 40px #ff0000, 0 0 60px #000, 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        #formulario {
            margin-top: 2rem;
            text-align: center;
        }

        input[type="text"] {
            padding: 10px;
            font-size: 1rem;
            border-radius: 10px;
            border: none;
            margin-right: 10px;
        }

        #juego {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        #infoJuego {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.2rem;
            background-color: rgba(0, 0, 0, 0.6);
            flex-wrap: wrap;
            box-shadow: 0 0 10px #ff0000;
        }

        .jugador-info {
            text-align: center;
            margin: 10px;
        }

        .turno-info {
            width: 100%;
            text-align: center;
            margin-top: 10px;
        }



        #tablero {
            display: grid;
            grid-template-columns: repeat(4, 100px);
            gap: 15px;
            margin-bottom: 2rem;
        }

       /* #nombreJugador {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        #infoJuego {
            display: flex;
            gap: 2rem;
            font-size: 1.2rem;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 1rem;
            box-shadow: 0 0 10px #ff0000;
        }*/



        #tablero {
            display: grid;
            grid-template-columns: repeat(4, 100px);
            gap: 15px;
            margin-bottom: 2rem;
        }

        .carta {
            width: 100px;
            height: 140px;
            perspective: 1000px;
            cursor: pointer;
        }

        .carta-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .carta.volteada .carta-inner {
            transform: rotateY(180deg);
        }

        .carta-front, .carta-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
        }

        .carta-back {
            background-image: url('/memorama/assets/traserocarta.png');
            background-color: #111;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
        }

        .carta-front {
            transform: rotateY(180deg);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #000; /* opcional */
        }


        button {
            background: #444;
            color: #fff;
            padding: 10px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

            button:hover {
                background: #666;
            }
        .pantalla-oculta {
            display: none !important;
            /*Asegura que no se muestre al cargar la página*/
        }

        #pantalla-final {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 30, 30, 0.95);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: aparecer 1s ease-in-out;
        }

        .contenedor-final {
            text-align: center;
            background: #222;
            padding: 2em;
            border-radius: 20px;
            box-shadow: 0 0 20px #000;
            animation: subir 0.6s ease;
        }

        @keyframes aparecer {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes subir {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .contenedor-final button {
            margin-top: 1em;
            padding: 0.5em 1.2em;
            border: none;
            background-color: #28a745;
            color: white;
            font-size: 1em;
            border-radius: 10px;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <h1>SUPERNATURAL</h1>

    <div id="formulario">
        <input type="text" id="inputNombre" placeholder="Escribe tu nombre">xx
        <button id="start-button">Iniciar</button>
        <h2 id="game-status" class="status" hidden>Esperando a otro jugador...</h2>
    </div>

    <div id="juego" hidden>
        <div>Tiempo: <span id="tiempo">00:00</span></div>
        <div id="infoJuego">
            <div class="jugador-info">
                <div id="nombreJugador"></div>
                <div>Pares: <span id="movimientos">0</span></div>
            </div>
            <div class="jugador-info">
                <div id="nombreJugador2"></div>
                <div>Pares: <span id="movimientos2">0</span></div>
            </div>
            <div class="turno-info">
                <p><strong>Turno de:</strong> <span id="currentPlayer"></span></p>
            </div>
        </div>
        <div id="tablero"></div>
        <button onclick="reiniciarJuego()">Reiniciar</button>
        <section class="status">
            <span id="turn-message"></span>
        </section>
    </div>
    <div id="pantalla-final" class="pantalla-oculta">
        <div class="contenedor-final">
            <h2>¡Juego Finalizado!</h2>
            <p id="mensaje-final"></p>
            <div class="puntajes">
                <p id="puntaje-jugador1"></p>
                <p id="puntaje-jugador2"></p>
            </div>
            <button onclick="reiniciarJuego()">Jugar de nuevo</button>
        </div>
    </div>

    <script>


        const personajes = [
            { nombre: "Dean", img: "/memorama/assets/dean.png" },
            { nombre: "Sam", img: "/memorama/assets/sam.png" },
            { nombre: "Castiel", img: "/memorama/assets/castiel.png" },
            { nombre: "Crowley", img: "/memorama/assets/jhon.png" },
            { nombre: "Bobby", img: "/memorama/assets/jack.png" },
            { nombre: "Lucifer", img: "/memorama/assets/charlie.png" }
          
        ];


        let cartas = [];
        let primera = null;
        let segunda = null;
        let bloqueo = false;
        let movimientos = 0;
        let movimientos2 = 0;
        let tiempo = 0;
        let intervaloTiempo = null;

        const startButton = document.getElementById("start-button");
        const playerNameSection = document.getElementById("formulario");
        const playerNameInput = document.getElementById("inputNombre");
        const tablero = document.getElementById('tablero');
        const spanMovimientos = document.getElementById('movimientos');
        const spanMovimientos2 = document.getElementById('movimientos2');
        const spanTiempo = document.getElementById('tiempo');
        const juegoSection = document.getElementById('juego');
        const gameStatus = document.getElementById("game-status");
        const turnMessage = document.getElementById("turn-message");
        const player1 = document.getElementById("nombreJugador");
        const player2 = document.getElementById("nombreJugador2");
        const turno = document.getElementById("currentPlayer");
   
        let nombre, idSesion, soyJugador1 = false;



        let estado = {
            Jugador1: player1,
            Jugador2: player2,
            Turno: turno,
        }
        // Para obtener el nombre del jugador que tiene el turno
        const jugadorConTurno = estado.Turno.textContent || estado.Turno.innerText;
        console.log("Jugador con turno:", jugadorConTurno);

        startButton.addEventListener("click", async () => {
            if (playerNameInput.value.trim()) {
                nombre = playerNameInput.value.trim();
                let json = { Nombre: nombre };

                gameStatus.hidden = false;
                playerNameInput.disabled = true;

                let response = await fetch("/memorama/quierojugar", {
                    method: "POST",
                    body: JSON.stringify(json),
                    headers: { "Content-Type": "application/json" }
                });

                if (response.ok) {
                    let juego = await response.json();

                    playerNameSection.hidden = true;
                    juegoSection.style.display = 'flex';

                    idSesion = juego.IdSesion;
                    player1.innerText = juego.Jugador1;
                    player2.innerText = juego.Jugador2;
                    turno.innerText = juego.Turno;



                    if (juego.Jugador1 == nombre) {
                        player1.style.color = "darkgreen";
                    }
                    else {
                        player2.style.color = "darkgreen";
                    }

                    const cartasBarajadas = juego.Cartas;
                    iniciarTemporizador();

                    if (juego.Turno == nombre) { //es mi turno
                        crearCartas(cartasBarajadas);
                       
                    }
                    else {
                        crearCartas(cartasBarajadas);
                        esperar();
                    }


                    if (juego.Turno === nombre) habilitarTablero();
                }
            } else {
                alert("Escribe el nombre del usuario para comenzar.");
            }
        });

        function crearCartas(cartasBarajadas) {
            cartas = cartasBarajadas;
            tablero.innerHTML = '';

            cartas.forEach((indice, i) => {
                console.log(`Buscando personaje con índice: ${indice}`);

                // Usamos el índice para acceder al personaje en el arreglo de personajes
                const personaje = personajes[indice];

                console.log('Cartas:', cartas);
                console.log('Personajes:', personajes);

                if (personaje) {
                    const carta = document.createElement('div');
                    carta.classList.add('carta');
                    carta.dataset.nombre = personaje.nombre;
                    carta.dataset.index = i;

                    carta.innerHTML = `
                        <div class="carta-inner">
                            <div class="carta-front" style="background-image: url('${personaje.img}')"></div>
                            <div class="carta-back"></div>
                        </div>
                    `;

                    carta.addEventListener('click', () => jugar(i));
                    tablero.appendChild(carta);
                    //  carta.classList.add('volteada'); // para pruebas, puedes quitar luego

                }
                else {
                    console.error(`No se encontró el personaje para: ${nombreCarta}`);
                }
            });
        }

        async function jugar(indice) {
            if (bloqueo || cartas[indice].volteada) return;

            // Verificar si es el turno del jugador
            const jugadorConTurno = estado.Turno.textContent || estado.Turno.innerText;

            // Verificar si es el turno del jugador
            if (jugadorConTurno !== nombre) {
                alert("No es tu turno.");
                return;
            }
            // Voltear carta localmente
            cartas[indice].volteada = true;
            const carta = tablero.children[indice];
            carta.classList.add('volteada');

            if (primera === null) {
                primera = indice;
                return;
            }

            segunda = indice;
            bloqueo = true;


            // Dale un segundo al usuario para ver la segunda carta antes de enviar
            setTimeout(async () => {
                const payload = {
                    Indice1: primera, Indice2: segunda, IdSesion: idSesion,
                    Nombre: jugadorConTurno
                };

                console.log("Payload:", payload); // Verifica que los valores sean correctos

                try {
                    const res = await fetch("/memorama/jugada", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    // Siempre parseamos el JSON para ver si viene error o datos válidos
                    const estado = await res.json();

                    // Si hay un error en el JSON, lo mostramos y salimos
                    if (estado.error) {
                        alert(estado.error);

                        // Volver a cubrir las dos cartas que volteaste localmente
                        tablero.children[primera].classList.remove('volteada');
                        tablero.children[segunda].classList.remove('volteada');
                        cartas[primera].volteada = false;
                        cartas[segunda].volteada = false;
                    }
                    else {
                        if (estado.Cartas[primera] === -1 && estado.Cartas[segunda] === -1) {
                            console.log("¡Pareja encontrada!");

                            actualizarVista(estado);

                        }
                        else {
                            // No eran pareja, volver a tapar
                            tablero.children[primera].classList.remove('volteada');
                            tablero.children[segunda].classList.remove('volteada');
                            cartas[primera].volteada = false;
                            cartas[segunda].volteada = false;
                        }

                        // Aquí ya es un estado válido de juego
                        actualizarVista(estado);

                        // Si no es tu turno, entras a la función esperar
                        if (!estado.EsMiTurno) esperar();
                    }
                }
                catch (e) {
                    console.error("Error de red o al parsear JSON:", e);
                    alert("Ocurrió un problema de comunicación con el servidor.");

                } finally {
                    // En cualquier caso, limpia el estado local de la jugada
                    primera = null;
                    segunda = null;
                    bloqueo = false;
                }
            }, 1000);
        }

        async function esperar() {
            let json = { IdSesion: idSesion, Nombre: nombre };

            try {
                let res = await fetch("/memorama/esperando", {
                    method: "POST",
                    body: JSON.stringify(json),
                    headers: { "Content-Type": "application/json" }
                });

                if (res.ok) {
                    try {
                        let estado = await res.json();

                        actualizarVista(estado);

                        if (!estado.finalizado) {
                            // Si el juego no ha terminado, seguimos esperando
                            actualizarVista(estado);
                            setTimeout(esperar, 500);
                          
                        } else if (estado.finalizado) {
                           // clearInterval(intervaloTiempo); // Detener el temporizador

                            const pantallaJuego = document.getElementById("juego");
                            if (pantallaJuego) pantallaJuego.hidden = true;

                        //CHECAR PANTALLA FINAL DE PUNTAJES
                            const pantallaFinal = document.getElementById("pantalla-final");
                            pantallaFinal.hidden = false;
                            pantallaFinal.classList.remove("pantalla-oculta");
                            pantallaFinal.style.display = "flex";



                            actualizarVista({
                                Cartas: estado.cartas,
                                Turno: "",
                                Jugador1: estado.jugador1,
                                Jugador2: estado.jugador2,
                                spanMovimientos: estado.paresJugador1,
                                spanMovimientos2: estado.paresJugador2,
                                tiempo: formatearTiempo(estado.tiempo)
                            });

                            // Mostrar mensaje personalizado
                            const mensaje = (estado.ganador === 'empate')
                                ? '¡Hubo un empate!'
                                : `🏆 ¡Ganó ${estado.ganador}!`;

                            document.getElementById("mensaje-final").innerText = mensaje;
                            document.getElementById("puntaje-jugador1").innerText = `${estado.jugador1}: ${estado.paresJugador1} parejas`;
                            document.getElementById("puntaje-jugador2").innerText = `${estado.jugador2}: ${estado.paresJugador2} parejas`;

                           
                            return;
                        }


                    } catch (e) {
                        console.error("Error al parsear JSON:", e);
                        setTimeout(esperar, 1000);
                    }
                } else {
                    console.error("Error en esperar:", res.statusText);
                    setTimeout(esperar, 1000);
                }
            } catch (error) {
                console.error("Error al realizar la solicitud:", error);
                setTimeout(esperar, 1000);
            }
        }




        function actualizarVista(estado) {
            // Actualizar el turno actual
            turno.innerText = estado.Turno;

            // Actualizar los movimientos de ambos jugadores (pares encontrados)
            spanMovimientos.innerText = estado.ParesJugador1;
            spanMovimientos2.innerText = estado.ParesJugador2;

            // Actualizar el tablero de cartas
            estado.Cartas.forEach((valor, i) => {
                const carta = tablero.children[i];
                if (valor === -1) {
                    carta.classList.add('volteada');
                    carta.style.pointerEvents = "none"; // Desactiva clic en cartas ya emparejadas
                }
            });

            // Actualizar quién tiene el turno visualmente
            if (estado.Turno === player1.textContent) {
                player1.style.color = "darkgreen";
                player2.style.color = "white";
            } else {
                player2.style.color = "darkgreen";
                player1.style.color = "white";
            }

            // Verificar si el juego ha terminado (todas las cartas están volteadas)
            const juegoFinalizado = estado.Cartas.every(valor => valor === -1);
            if (juegoFinalizado) {
                clearInterval(intervaloTiempo); // Detener el temporizador

                // Determinar ganador
                let ganador;
                if (estado.ParesJugador1 > estado.ParesJugador2) {
                    ganador = player1.textContent;
                } else if (estado.ParesJugador2 > estado.ParesJugador1) {
                    ganador = player2.textContent;
                } else {
                    ganador = "Empate";
                }

                //setTimeout(() => {
                //    alert(`¡Juego finalizado!\n\nGanador: ${ganador}\n${player1.textContent}: ${estado.ParesJugador1} pares\n${player2.textContent}: ${estado.ParesJugador2} pares`);
                //}, 500);
            }
        }



        function deshabilitarTablero() {
            for (let carta of tablero.children) {
                carta.style.pointerEvents = "none";
            }
        }

        function habilitarTablero() {
            for (let carta of tablero.children) {
                carta.style.pointerEvents = "auto";
            }
        }

        function reiniciarJuego() {
            location.reload();
        }

        function iniciarTemporizador() {
            intervaloTiempo = setInterval(() => {
                tiempo++;
                spanTiempo.textContent = formatearTiempo(tiempo);
            }, 1000);
        }

        function formatearTiempo(segundos) {
            const mins = Math.floor(segundos / 60).toString().padStart(2, '0');
            const secs = (segundos % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }

        function actualizarCartas(cartas) {
            cartas.forEach((valor, i) => {
                const carta = document.querySelector(`[data-index='${i}']`);
                if (carta) {
                    if (valor === -1) {
                        carta.style.visibility = "hidden";
                    } else {
                        const personaje = personajes[valor];
                        carta.querySelector('.carta-front').style.backgroundImage = `url('${personaje.img}')`;
                    }
                }
            });
        }




    </script>
</body>
</html>

